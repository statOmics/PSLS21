---
title: "Exercise 8.x: Additive linear model on the poison dataset - solution"   
author: "Lieven Clement and Jeroen Gilis"
date: "statOmics, Ghent University (https://statomics.github.io)"  
output:
    html_document:
      code_download: true    
      theme: cosmo
      toc: true
      toc_float: true
      highlight: tango
      number_sections: true
---

# Fish tank dataset

In this experiment, 96 fish (dojofish, goldfish and zebrafish)
were placed separately in a tank with two liters of water and
a certain dose (in mg) of the poison EI-43,064. The resistance
of the fish against the poison was measured as the amount of
minutes the fish survived after being exposed to the poison (`Surv_time`, in
minutes). Additionally, the weight of each fish was measured.

# Goal

The research goal is to study the association between the dose of
the poison that was administered to the fish and their survival time.

Load libraries

```{r, message=FALSE, warning=FALSE}
library(tidyverse)
library(ggplot2)
#install.packages("GGally")
library(GGally)
library(car)
library(multcomp)
```

# Import the data

```{r, message=FALSE}
poison <- read_csv("https://raw.githubusercontent.com/statOmics/PSLS21/data/poison.csv")
```

# Data tidying

We can see a couple of things in the data that can be improved:

1. Capitalise the fist column name

2. Set the Species column as a factor

3. Change the species factor levels from 0, 1 and 2 to
Dojofish, Goldfish and Zebrafish. *Hint*: use the `fct_recode` function.

4. In previous analysis on this dataset (`Simple linear regression session`), we
performed a log-transformation on the response variable `Surv_time` to meet the
normality and homoscedasticity assumptions of the linear model. Here, we will
immediately work with log-transformed survival times; store these in the new 
variable `log2Surv_time` and remove the non-transformed values.

```{r}
poison <- poison %>%
  rename("Species" = "species") %>%
  mutate(Species = as.factor(Species)) %>%
  mutate(Species = fct_recode(Species, Dojofish = "0", Goldfish = "1", Zebrafish = "2")) %>%
  mutate(log2Surv_time = log2(Surv_time)) %>%
  dplyr::select(!Surv_time)

poison
```

# Data exploration (extensive)

Prior to the analysis, we should explore our data. We have a rather complex 
dataset: as discussed in the **session on simple linear regression session**, we
can imagine how the (log2) survival time of the fish not only depends on the
dose of poison that was administered, but also on the weight of the fish and
the fish species.

To start our data exploration, we will make use of the `ggpairs` function of the
`GGally` R package. This function will generate a visualization containing
multiple panels, which display (1) univariate plots of the different variables
in our dataset, (2) bivariate plots and (3) correlation coefficients between 
the different variables.

```{r, message=FALSE}
poison %>%
  ggpairs + theme_bw()
```

Based on these plots, we observe that:

- The survival time seems to be associated with dose, fish weight and species.

- The association between weight and survival time is very strong and positive.

- Species 2 (gold fish) are more resistant to the poison.

- There is an association between weight and species.

Knowing this, we now make additional relevant visualizations.

First, make a scatterplot that displays the association between poison dose and
log2 survival time. To check if this association could be linear, we fit a
linear regression line and a smooth "loess" line through the data cloud.

```{r, message=FALSE}
poison %>%
  ggplot(aes(x=Dose,y=log2Surv_time)) +
  geom_point() + 
  stat_smooth(method = "loess") +
  geom_smooth(method='lm',col="black") + 
  ylab("Survival time (log2 min)") +
  xlab("Dose (mg)") +
  theme_bw()
```

The linear regression line (black) is a good approximation of the best fitting 
smooth line (blue) through the data. Based on this figure, it seems realistic to
suggest a linear relationship between dose and survival, where higher doses
have lower (log2) survival times.

However, this plot is missing the effect that the other explanatory variables,
fish weight and species, may have on the relationship between dose and survival
time. To assess the effect of species, we may color each dot in the above
scatterplot according to species. In addition, we may fit a separate linear 
regression line for each species.

```{r, message=FALSE}
poison %>%
  ggplot(aes(x = Dose, y = log2Surv_time, col=Species)) +
  geom_point(size=2) +
  scale_color_manual(values = c("red", "darkgoldenrod", "black")) +
  stat_smooth(method = "lm", se = FALSE) + # se = FALSE omits confidence 
  # interval around regression line to make to plot less cluttered
  ylab("Survival time (log2 min)") +
  xlab("Dose (mg)") +
  ggtitle("Association between dose and survival time - per species") +
  theme_bw()
```

We indeed observe a strong influence of species on the survival time. 
Clearly, zebrafish have the lowest survival time, whereas goldfish have the 
highest survival time. However, we also see that the slopes of the different
regression lines are very similar between the different species, suggesting a
limited interaction of the species effect and the relationship between dose
and survival time **(see later theory session on interactions).**

Next, we make a scatterplot to visualize the relationship between fish weight 
and survival time. We again fit a smooth "loess" curve through the data cloud.
Wee additionally color the observation according to species.

```{r, message=FALSE}
poison %>%
  ggplot(aes(x = Weight, y = log2Surv_time, col = Species)) +
  geom_point() +
  scale_color_manual(values = c("red", "darkgoldenrod", "black")) +
  stat_smooth(method = "loess", col="blue") +
  ylab("Survival time (log2 min)") +
  xlab("Weight") +
  ggtitle("Association between weight and survival time") +
  theme_bw()
```

We observe a clear, positive relationship between fish weight and survival time,
with heavier fish living longer than lighter fish. We also observe that fish 
weight is associated with fish species, with zebrafish being the lightest fish,
on average. Wee may visualize this relationship more clearly using boxplots

```{r}
poison %>% 
  ggplot(aes(x = Species, y = Weight, col = Species)) +
  geom_boxplot(outlier.shape = NA) +
  geom_jitter() +
  scale_color_manual(values = c("red", "darkgoldenrod", "black")) +
  ylab("Weigth (g)") +
  ggtitle("Association between species and weight") +
  theme_bw()
```

Next, we maay assess the association between species and log2 survival time 
using boxplots.

```{r}
poison %>% 
  ggplot(aes(x = Species, y = log2Surv_time, col = Species)) +
  geom_boxplot(outlier.shape = NA) +
  geom_jitter() +
  scale_color_manual(values = c("red", "darkgoldenrod", "black")) +
  ylab("Survival time (log2 min)") +
  ggtitle("Association between species and survival time") +
  theme_bw()
```

There is a clear association between species and log2 survival time. However,
not that the relationship between species and survival time is *confounded* 
with the effect of weight!

Finally, there is one additional, less expected relationship between the
different variables in the data. We make a scaatterplot for Dose and weight.

```{r, message=FALSE}
poison %>%
  ggplot(aes(x = Dose, y = Weight)) +
  geom_point() +
  ggtitle("Association between dose and weight") +
  theme_bw() + 
  stat_summary(
    geom = "point",
    fun.y = "mean",
    col = "black",
    size = 4,
    shape = 24,
    fill = "red")
```

We additionally observe that the average weight of the fish not uniform for
the different dose that were administered. This can be explained by the fact
that the experimental design was not balanced with respect to species and dose.
More specifically, each dose was administered to 8 fish,

```{r}
colSums(table(poison$Species, poison$Dose))
```

however, the distribution of species across the different doses is variable.   

```{r}
table(poison$Species, poison$Dose)
```

However, even if we would subset the data to e.g. contain only dojofish,
the fish weights are still not nicely uniform accros the different poison
dosages (due to random fluctions).

```{r, message=FALSE}
poison %>%
  filter(Species == "Dojofish") %>%
  ggplot(aes(x = Dose, y = Weight)) +
  geom_point() +
  ggtitle("Association between dose and weight") +
  theme_bw() + 
  stat_summary(
    geom = "point",
    fun.y = "mean",
    col = "black",
    size = 4,
    shape = 24,
    fill = "red")
```

In conclusion, we see that all three explanatory variables (dose, species and 
weight) seem to have an effect on the log2 survival time. In addition, these
explanatory variable or also not independent. As such, we should try to come up
with a model that accomodates these different effects.

Ideally, we should construct a model that accounts for all the different
associations observed in the data exploration. Such model should

- model the association between `Dose` and `log2 survival time`, while

- accounting for the `species` effect,

- accounting for the `weight` effect,

- accounting for the fact that the association between `Dose` and 
`log2 survival time` may be different for different `species`.

- and accounting for the fact that the association between `Dose` and 
`log2 survival time` may be different for fish of different `weight`.

**By the time of the last exercise session in this series, we will learn how**
**to construct such a model. For now, we will simplify the research question**
**by reducing the dataset to contain only a single fish species, the**
**dojofish, i.e.:**

```{r}
poison_dojo <- poison %>%
    filter(Species == "Dojofish")
```

**For demonstrational purposes, we will analyse this reduced dataset with**
**three different strategies with increasing complexity:**

**1. a simple linear regression model (insufficient)**
**2. an additive linear regression model (insufficient)**
**3. a linear regression model with interaction**

# Simple linear regression (insufficient)

This is the same regression model that we have already fit in the exercise 
session on simple linear regression, with `Dose` as the only explanatory 
variable for `log2Surv_time`.

```{r}
# fit a linear regression model with 'Surv_time' as response variable and
# 'Dose' as predictor variabele
lm_simple <- lm(log2Surv_time ~ Dose, data=poison_dojo) 

## display the diagnostic plots of the model
par(mfrow=c(2,2))
plot(lm_simple)
```

1. The independence assumption not met, given that we expect that fish of
similar weight will have a similar association between dose and survival time.
**For now, we will ignore this problem.**
2. The linearity assumption is **met**.
3. The normality assumption is **met**.
4. The homoscedasticity assumption is **met**.

Finally, we look at the output of the model.

```{r}
summary(lm_simple)
```

Or for an interpretation at the original scale (minutes in stead of log2 
minutes):

```{r}
2^(lm_simple$coef)["Dose"]
2^(confint(lm_simple))[2,1]
```

There is an extremely significant effect of the poison dose on the 
log2-transformed survival time of dojofish 
(p-value = `r format(summary(lm_simple)$coefficients[2,4],digits=3)`). For each
extra milligram of poison administered, the geometric mean of survival time will
decrease by a factor of `r format(unname(2^(lm_simple$coef)["Dose"]), digits=3)`,
(95% CI [`r format(unname(2^(confint(lm_simple))[2,1]), digits=3)`,
`r format(unname(2^(confint(lm_simple))[2,2]), digits=3)`]).

However, we know we have to be very careful with these results, since we did not 
include weight as a covariate to our model!

# Analysis with additive effect for weight

## Model specification

In a fist attempt to account for the effect of `weight`, we may add the `weight`
variable as an additional covariate to our linear regression model, such that

$$
y_i=\beta_0+\beta_d x_d + \beta_g x_g + \epsilon_i,
$$

with $\epsilon_i \text{ i.i.d. } N(0,\sigma^2)$.

## Assumptions

The model will again be fit to allow for assessing the model assumptions

```{r}
lm_additive <- lm(log2Surv_time ~ Dose + Weight, data = poison_dojo)

par(mfrow=c(2,2))
plot(lm_additive)
```

The assumption of independence (!), linearity and homoscedasticity are met.

Arguably, there might be some deviation from normality in the left tail of the
distribution. However, when we would simulate data under the normality
assumption, it seems that deviations of this size may be expected when
normality is met:

```{r}
set.seed(1406)
nobs <- nrow(poison_dojo)

data.frame(
  y = c(lm_additive$res,
        rnorm(nobs*8,
              sd = sigma(lm_additive)
             )
      ),
  label = rep(
              c("original data",
                paste0("simulation ",1:8)),
              each = nobs)) %>%
  ggplot(aes(sample = y)) +
  geom_qq() +
  geom_qq_line() +
  facet_wrap(~ label) +
  theme_bw()
```

As such, all assumptions for linear regression are met.

## Inference

We then inspect the results.

```{r}
summary(lm_additive)
```

## Interpretation of model parameters

We see that the effect of dose on survival time has become more significant 
after we have incorporated weight in our model. This makes sense, because

1. From the data exploration, we learned that weight is associated with 
survival. As such, by incorporating weight in our model, we are able to
explain a larger part of the variability in the response variable survival time.
As a consequence, the variability in the residuals of the model will decrease,
which in turn will lead to smaller standard error estimates for the different
parameter estimates in the model.

2. From the data exploration, we additionally found that the (dojo-)fish weights
are not perfectly uniform across the different poison dosages. Therefore, the 
pure effect between dose and survival time maay be somewhat disturbed by these 
(unwanted) fluctuations in weight, since we know fish weight also affects
survival time. As such, we will be able to better estimate the pure effect
between dose and survival if we *correct* the analysis for the effect of weight.

In conclusion, we will be able to (1) estimate the dosage effect more precisely 
and (2) estimate the dosage effect with less bias wheen we add weight as an
additional covariate to our model.

In this model, the effect of `Dose` can be interpreted as the average change in
the log2 survival time betwn two groups of dojofish **with the same weight** 
that are exposed to a poison dosage that differs 1 mg/L. In symbols:

\begin{eqnarray}
\hat{\mu_1}&=& \beta_0 + \beta_d x_{1d} + \beta_g x_g \text{ (average log2-survival time for dose 1 for a certain weight)}\\
\hat{\mu_2}&=& \beta_0 + \beta_d x_{2d} + \beta_g x_g \text{ (average log2-survival time for dose 2 for that same weight)}\\
\hat \mu_2- \hat \mu_1&=&\beta_0 + \beta_d x_{2d} + \beta_g x_g - (\beta_0 + \beta_d x_{1d} + \beta_g x_g) \text{ (difference in average log2-survival time between dose 2 en dose 1)}\\ 
\hat \mu_2-\hat \mu_1&=&\beta_d (x_{2d}-x_{1d})
\end{eqnarray}

If the difference in poison concentration is $(x_{2d}-x_{1d})=1$ mg/l,
then we indeed observe that $\hat \mu_2-\hat \mu_1=\beta_d$. $\beta_d$ thus
quantifies the as average change in the log2 survival time betwn two groups of 
dojofish **with the same weight**.

## Conclusion

```{r}
2^(lm_additive$coef)
2^(confint(lm_additive))
```

The dose of the poison has an extremely significant effect on the survival time
of dojofish 
(p-value = `r format(summary(lm_additive)$coefficients[2,4],digits=3)`). The
geometric average of the survival time of dojofish is reduced (approximately
halfed, 
factor = $2^{\beta_d}=$ `r format(2^(lm_additive$coef["Dose"]),digits=3)`) if
the dose of poison is increased with 1 mg/L 
(95% BI [`r paste(format(2^(confint(lm_additive)["Dose",]),digits=3),collapse=",")`]).

The effect of weight on the survival time of dojofish is also extremely 
significant 
(p-value = `r format(summary(lm_additive)$coefficients[3,4],digits=3)`). The
geometric average of the survival time of a dojofish that weighs 1 gram extra
compared to another dojofish is approximately twice as long 
(factor = $2^{ \beta_g}$= `r format(2^(lm_additive$coef["Weight"]),digits=3)`, 
95% BI [`r paste(format(2^(confint(lm_additive)["Weight",]),digits=3),collapse=",")`]).

## Remarks

In the `lm_additive` model, we included only a *main effect* for weight. 
However, there could also be an *interaction effect* between weight and
dose. This potential interaction effect can be thought of as follows:
the relationship between dose and survival time may be influenced by differences
in fish weight. The weight main effect, on the other hand, only models the 
direct effect of fish weight on survival time.

Since we do not know in advance if the *interaction effect* is significant, 
we should always first include the interaction effect in our model. If this 
effect turns out to be insignificant, we may ommit the interaction term from 
the model to obtain aa *reduced* model (model selection).

# Analysis with interaction and main effect for weight

## Model specification

$$
y_i=\beta_0+\beta_d x_d + \beta_g x_g +\beta_{d:g} x_d x_g+ \epsilon_i,
$$

with $\epsilon_i \text{ i.i.d. } N(0,\sigma^2)$

## Assumptions

The model will again be fit to allow for assessing the model assumptions

```{r}
# lm_Int <- lm(log2Surv_time ~ Dose+Weight+Dose:Weight, data = poison_dojo) # equivalent
lm_Int <- lm(log2Surv_time ~ Dose*Weight, data = poison_dojo) # * -> short notation

par(mfrow=c(2,2))
plot(lm_Int)
```

All assumption are **met**.

## Inference

We then inspect the results.

```{r}
summary(lm_Int)
```

## Interpretation of model parameters

We may interpret the estimate parameters as follows:

- For a fish with weight $x_g$, the expected log2 survival time will be 
$\beta_d+\beta_{d:g}*x_g$ higher when the poison dose is increased with 1 mg/L,
as compared to fish with the same weight.

- For a wish that was exposed to dose $x_g$, the expected log2 survival time 
will be  $\beta_d+\beta_{d:g}*x_g$ higher for a fish with a weight that is
1 gram higher than that of another fish.

The parameter $\beta_{d:g}$ can thus be interpreted in two ways. The easiest
one is that the effect of dose on the log2 survival time is dependent on the
weight of the fish. Alternatively, it can also be interpreted as the effect
of weight on the log2 survival time being dependent on the dose that was
administered.

## Inference

The effect of dose is now parameterized by two model parameters ($\beta_d$ 
and $\beta_{d:g}$). We first evaluate an *omnibus* hypotheses that there is
no effect of dose, i.e., no main effect nor an interaction effect. We can test
this with aan F-test that compares a *full* model (1) containing a main effect 
for dose, a main effect for weight and an interaction between dose and weight
with a model (2) that only contains a main effect for weight (i.e. no effect
for dose).

```{r}
#lmDojo_weight <- lm(log2Surv_time ~ Dose*Weight, data = poison_dojo)
lmDojo_weight <- lm(log2Surv_time ~ Weight, data = poison_dojo)
anova(lmDojo_weight, lm_Int)
```

We observe an extremely significant (overall, or global) effect for dose on 
the log2 survival time of dojofish 
(p-value = `r format(anova(lmDojo_weight, lm_Int)[2,6],digits=3)`.

## Conventional approach

We already estbalished that there is a significant overall effect of dose.
Now, we will test if there is a significant interaction effect between dose 
and weight. Since we only have one interaction term in this model, this can
be achieved in several ways:

1. The `summary` function
2. An F-test comparing models with and without the interaction effect
3. An ANOVA table with type III sum of squares  


```{r}
summary(lm_Int) #1
anova(lm_additive,lm_Int) #2
Anova(lm_Int,type="III") #3
```

There is no significant interaction between dose and weight. As such, the
effect of dose on survival is not signifiantly different between fish of
different weight.

The conventional approach is to now remove the interaction effect from the 
model. As such, we are left with the additivee linear regression model
`lm_additive` that we have alreaady fitted above.

```{r}
summary(lm_additive)
```

```{r}
2^(lm_additive$coef) # original scale
2^(confint(lm_additive))
```

### Conclusion

The conclusion is exactly the same as for the additive model analysis above 
(obviously, as we are dealing with the same model):

The dose of the poison has an extremely significant effect on the survival time
of dojofish 
(p-value = `r format(summary(lm_additive)$coefficients[2,4],digits=3)`). The
geometric average of the survival time of dojofish is reduced (approximately
halfed, 
factor = $2^{\beta_d}=$ `r format(2^(lm_additive$coef["Dose"]),digits=3)`) if
the dose of poison is increased with 1 mg/L 
(95% BI [`r paste(format(2^(confint(lm_additive)["Dose",]),digits=3),collapse=",")`]).

The effect of dose on survival is not signifiantly different between fish of
different weight. (p = `r format(summary(lm_Int)$coefficients[4,4], digits=2)`).

## Alternative approach

Alternatively, we may perform an analysis without removing the interaction 
effect.

```{r}
summary(lm_Int)
```

The interaction effect is not significant, so we would accept the null
hypothesis that there is no interaction effect. However, accepting a null
hypothesis is a **weak conlusion**. In addition, we know that the **power to**
**find an interaction effect is low**. As such, we may still want to include
an interaction effect in the model (if we want to play safe).

With this model, we could still say something about the average dosis effect
for the dojofish in this experiment. This would require us to **marginalize**
accros all dojofish in the experiment, i.e.,

$$
\frac{\sum\limits_{i=1}^{n_\text{dojo}} (\beta_d + \beta_{d:w} x_{iw})}{n_\text{dojo}} = \beta_d + \beta_{d:w} \bar{x}_w
$$

In other words, we aree estimating the dose effect for 
**"the average dojofish"** in the experiment.

```{r}
wBar <- poison %>%
  pull(Weight) %>%
  mean
wBar
```

The average weigth for a dojofish in this experiment is
`r round(wBar, 2)` grams.

We now evaluate the contrast for the marginal dose effect, i.e., if
$\beta_d+2.1313*\beta_{d:g}$ is significantly different from zero.

```{r}
marginalDosisEffect <- glht(lm_Int, linfct = c("Dose + 2.1313*Dose:Weight = 0"))
summary(marginalDosisEffect)
```

```{r}
confint(marginalDosisEffect)
2^confint(marginalDosisEffect)$confint
```

**! notice that the marginal dosis effect is almost exactly the same as the**
**effect that was estimated for the model without the interaction effect!**

### Conclusion

We observe an extremely significant (overall, or global) effect for dose on 
the log2 survival time of dojofish 
(p-value = `r format(anova(lmDojo_weight, lm_Int)[2,6],digits=3)`.


The effect of dose on survival is not signifiantly different between fish of
different weight. (p = `r format(summary(lm_Int)$coefficients[4,4], digits=2)`).

The marginal geometric average of the log2 survival approximateely halves 
(factor = `r format( 2^confint(marginalDosisEffect)$confint[1,1], digits=3)`)
for fish that are subjectd to a dose that is 1 mg/L higher
(95% CI [`r paste(format(2^confint(marginalDosisEffect)$confint[1,-1],digits=3),collapse=", ")`]), after correction for weight
(p-value = `r format(summary(marginalDosisEffect)$test$pvalues[1],digits=3)`.








---
title: "Exercise 8.x: Blocking on the estrogen dataset - solution"   
author: "Lieven Clement and Jeroen Gilis"
date: "statOmics, Ghent University (https://statomics.github.io)"  
output:
    html_document:
      code_download: true    
      theme: cosmo
      toc: true
      toc_float: true
      highlight: tango
      number_sections: true
---

# Background

A 2x2 factorial experiment on cancer cell cultures is performed. Two factors 
were considered in this experiment: estrogen (present or absent) and length of 
exposure (10 or 48 hours). The study aims to discriminate between early and 
late response. The researchers assessed gene expression of the TK1 gene 
(thymidine kinase 1, soluble) a protein-coding gene associated with colorectal 
cancer. 

Note, that the tk1 variable consists of background corrected normalized 
$\log_2$ transformed intensities, which are a proxy for the $\log_2$ transformed
concentration of gene expression product of the TK1 gene. 

# Experimental design 

- There are two explanatory variables: factor estrogen (present and absent) and
time (early vs late). 

- There response variable is the normalized log2-transformed intensity for 
the TK1 gene.

- The experimental and observational units are the 8 different cell cultures.

- The treatments are: early-absent, early-present, late-absent and late-present.

- The design is a randomized complete block design.

# Research hypotheses

- Is there an early response of the TK1 gene on the estrogen treatment?

- Is there a late response of the TK1 gene on the estrogen treatment?

- Does the response of the TK1 gene on the estrogen treatment change over time? 

Load libraries

```{r, message=FALSE, warning=FALSE}
library(tidyverse)
```

# Data import

```{r}
tk1 <- read.table("https://raw.githubusercontent.com/statOmics/PSLS21/data/estrogenTk1.txt",
                  sep=",",
                  header=TRUE)
head(tk1)
```

# Tidy data

We have two columns indicating time. The first `time.h` should display numeric
values, but `time.f` should display time categories; change `time.f` to a
factor using `dplyr`. Additionally, change `estrogen` to a factor.

```{r}
tk1 <- tk1 %>%
    mutate(time.f = as.factor(time.f), estrogen = as.factor(estrogen))
```

# Data exploration

Time and estrogen treatment both may have an effect on the tk1 gene. Moreover, 
it is also possible that the response on the estrogen treatment changes over 
time. Therefore, we plot the gene expression for each treatment combination. 
We do not use boxplots here because there are only two biological repeats for 
each treatment x time combination. In stead, we make a scatterplot. Note, to
avoid overplotting the points, we make use of `geom_jitter`.

```{r}
set.seed(4684165) # to make jitter reproducible
tk1 %>%
  ggplot(aes(x = time.f:estrogen, y = tk1, col = time.f:estrogen)) +
  geom_jitter(width=0.2) +
  theme_bw() +
  ylab("log2 TK1 intensity") +
  xlab("time x estrogen combination") +
  ggtitle("TK1 expression in function of time and estrogen")
```

The plot suggests

1. an estrogen response at both early and late timepoint
2. an effect of time
3. a potential change in estrogen response between early and late timepoint.

Since there are only two biological repeats for every treatment combination 
the plot does not allow us to learn much about variability in gene expression 
for every treatment*time combination. 

# Analysis 1: early response (only)

Time and estrogen treatment can have an effect on the tk1 gene. Moreover, it is
also possible that the response on the estrogen treatment changes over time. 
Hence, we will have to model the gene expression by using main effects for time,
estrogen and a time*estrogen interaction. 

## Assumptions

List assumptions:

1. The observations are independent of each other
2. Linearity between the response and predictor variable
3. The residues of the model must be normally distributed
4. Homoscedasticity of the data

The assumption of independence is met, each of the 8 cell cultures was randomly
assigned to a time and treatment combination.

For the remaining assumptions, we fit a linear model with a main effects for 
estrogen dosage, a main effect for time and an estrogen-time interaction effect.
 
```{r}
fit <- lm(tk1 ~ estrogen*time.f, data = tk1)
plot(fit)
```

There is not enough data to assess equality of the variance for every 
treatment x time combination. The QQ-plot of the residuals suggests some 
deviations from normality, however, there are only a limited number of 
observations to assess normality. 

**For demonstrational purposes, we will continue the analysis, but keep in**
**mind that we do not have enough data to be sure that the assumptions of the**
**model hold! We will come back to this in the `conclusions` section.**
 
## Interpretation of model parameters and statistical tests

We obtain the following estimates for our linear regression model,

```{r}
summary(fit)
```

and the following corresponding confidence intervals on these estimates.

```{r}
CIfit <- confint(fit)
CIfit
```

Next, we should carefully think about the interpretation of these model 
parameters. We model the log$_2$-transformed intensities with the following 
regression model: 

$$
y=\beta_0+\beta_{e}x_{e}+\beta_{t}x_{t}+\beta_{et}x_{e}x_{t},
$$

with 

- $\beta_0$ the intercept,

- $\beta_{e}$ the main effect for estrogen, 

- $x_{e}$ a dummy variable for estrogen which is 0 for the control treatment in 
the absence of estrogen and 1 for the treatment with estrogen, 

- $\beta_{t}$ the main effect for time, 

- $x_{t}$ a dummy variable that is 0 for the measurements at the early time 
(10h) and 1 for measurements at the late timepoint (48h) 

- $\beta_{et}$ the interaction effect between estrogen and time. 

To ease the interpretation of the parameters, $\log_2$ transformed mean 
intensities are given for each treatment group as well as corresponding 
contrasts between treatments, which have an interpretation in terms of $\log_2$ 
transformed fold changes (FC). 

- $\log_2\hat \mu_{A10}=\hat\beta_0$, $\log_2 \hat\mu_{P10}=\hat\beta_0+\hat\beta_e$ 
-->   $\log_2 \widehat{FC}_{P10-A10}=\hat\beta_e$

- $\log_2 \hat \mu_{A48}=\hat\beta_0+\hat\beta_t$, $\log_2 \hat \mu_{P48}=\hat\beta_0+\hat\beta_e+\hat\beta_t+\hat\beta_{et}$ 
-->   $\log_2 \widehat{FC}_{P48-A48}=\hat \beta_e +\hat\beta_{et}$

- $\log_2 \widehat{FC}_{A48-A10}=\hat\beta_{t}$, $\log_2 \widehat{FC}_{P48-P10}=\hat\beta_{t}+\hat\beta_{et}$ 
-->   $\log_2\frac{\widehat{FC}_{P48-A48}}{\widehat{FC}_{P10-A10}}=\hat\beta_{et}$

with $\log_2\hat \mu_{A10}$, $\log_2\hat \mu_{P10}$, $\log_2\hat \mu_{A48}$ 
and $\log_2\hat \mu_{P48}$ the estimated mean $\log_2$ transformed intensity 
for the control treatment in the absence of estrogen at 10h, the estrogen 
treatment at 10h, the control treatment at 48h and the estrogen treatment 
at 48h, respectively. With $\log_2 \widehat{FC}_{b-a}$ we indicate $\log_2$ 
transformed fold change estimates between treatment B and treatment A, 
i.e. $\log_2 \widehat{FC}_{b-a}=\log_2 \hat\mu_{b}-\log_2 \hat\mu_a=\log_2 \frac{\hat\mu_{b}}{\hat\mu_{a}}$.

The model immediately provides statistical tests for assessing the significance 
of fold changes between the estrogen and control treatment at the early time 
point $\log_2 \widehat{FC}_{P10-A10}$, fold changes between the control at 
the late time point and the control at the early time point 
$\log_2 \widehat{FC}_{A48-P10}$ and for changes in fold change between 
control and estrogen treatment at the late and the early timepoint $\log_2\frac{\widehat{FC}_{P48-A48}}{\widehat{FC}_{P10-A10}}$, the interaction 
term. 

```{r}
summary(fit)
```

For communicating the results, we may transform the model parameters to the
original scale, i.e., the (geometric) average intensity in stead of the average 
log2 intensity, using:

```{r}
# Transform parameters and the CI back to the original scale
2^fit$coef
2^CIfit
```

- The geometric average intensity for the control treatment on the early 
timepoint equals $\exp(\hat \beta_0)$=`r round(2^fit$coef["(Intercept)"],2)`.

- The estrogen effect at the early time point and the time effect are extremely 
significant (p<<0.001). 

- The expression of the tk1 gene at the early timepoint is on average 
`r round(2^fit$coef["estrogenpresent"],2)` times higher after estrogen treatment 
(95% CI [`r round(2^CIfit["estrogenpresent",],2)`]). 

- The gene expression in the control treatment is on average 
`r round(1/2^fit$coef["time.f48"],2)` times lower (or 
`r round(2^fit$coef["time.f48"],2)` times higher) at the late time point 
(95% CI [`r round(1/2^CIfit["time.f48",],2)`]).

- The difference in estrogen response at the late timepoint and the early 
timepoint is strongly significant (p=0.009). The fold change due to the estrogen
treatment is on average `r round(2^fit$coef["estrogenpresent:time.f48"],2)` 
times higher at the late time point 
(95% CI [`r round(2^CIfit["estrogenpresent:time.f48",],2)`]).

# Analysis 2: Late response (only)

The researchers, however, are also interested in testing the significance of
the fold change between estrogen and control treatment at the late timepoint.
This involves assessing a contrast of the model parameters:
$\log_2 \widehat{FC}_{P48-A48}=\hat \beta_e +\hat\beta_{et}$. We can test this 
linear combination of model parameters using the `multcomp` package.

## Test

```{r, message=FALSE, warning=FALSE}
library(multcomp)

testFCP48_A48 <- glht(model = fit, 
                      linfct = "estrogenpresent + estrogenpresent:time.f48 = 0")
summary(testFCP48_A48)
```

### Confidence intervals FC at time 48h.

```{r}
# CI for fold changes on time point 48h
CIFCP48_A48 <- confint(testFCP48_A48)
CIFCP48_A48
```

For communicating the results, we may transform the model parameters to the
original scale, i.e., the (geometric) average intensity in stead of the average 
log2 intensity, using:

```{r}
# Original scale
2^CIFCP48_A48$confint
```

The estrogen effect at the late time point is also extremely significant 
(p<<0.001). The expression of the tk1 gene at the late timepoint is on average 
`r round(2^CIFCP48_A48$confint,2)[1]` times higher after estrogen treatment 
(95% CI [`r round(2^CIFCP48_A48$confint,2)[-1]`]). 

# Analysis 3: simultaneously assess all research hypotheses

Alternatively, we can simultaneously assess all research hypotheses for our
linear regression model using the package `multcomp`. This is the most elegant
way for addressing all research hypotheses, and additionally allows for 
efficient multiple testing correction.

```{r}
testFCAll <- glht(model = fit, 
                  linfct = c("estrogenpresent = 0",
                             "estrogenpresent + estrogenpresent:time.f48 = 0",
                             "estrogenpresent:time.f48 = 0"))
summary(testFCAll)
```

```{r}
# Confidence intervals 
CIFCAll <- confint(testFCAll)
CIFCAll
```

For communicating the results, we may transform the model parameters to the
original scale, i.e., the (geometric) average intensity in stead of the average 
log2 intensity, using:

```{r}
# Confidence intervals on original scale
2^CIFCAll$confint
```

# Conclusions

There was an extremely significant effect of estrogen on the expression of the 
TK1 gene 10h and 48h after estrogen dosage ( $p<<0.001$). 

The TK1 gene was significantly upregulated after estrogen treatment as compared
to a control treatment without estrogen. On average, the fold change between 
the estrogen treatment and control varied form 
`r round(2^CIFCAll$confint[2,1],2)` 
(95% CI [`r round(2^CIFCAll$confint[1,2:3],2)`]) 10 hours after 
estrogen dosage up to `r round(2^CIFCAll$confint[2,1],2)` 
(95% CI [`r round(2^CIFCAll$confint[2,2:3],2)`]) at the late timepoint 
(48h), respectively.  

The increase in fold change between the early and the late timepoint was 
significant ($p=0.02$), fold change increase: 
`r round(2^CIFCAll$confint[3,1],2)`, 
95% CI [`r round(2^CIFCAll$confint[3,2:3],2)`]). 

All p-values and confidence intervals were adjusted for multiple testing. 


